{% extends "base.html" %}
{% block title %}Admin · ScheduleBooker{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}
<div class="calendar-wrapper">
  <div class="admin-toolbar">
    <div class="admin-toolbar-left">
      <h1 class="admin-title">Admin calendar</h1>
      <p class="admin-subtitle">Manage bookings and schedules.</p>
    </div>

    <div class="admin-toolbar-right">
      <label class="sr-only" for="admin-date">Date</label>
      <input id="admin-date" class="admin-date" type="date" value="{{ date }}" />

      <div class="controls" role="tablist" aria-label="Calendar views">
        <button id="day-view-btn" class="active" type="button" role="tab" aria-controls="day-view">Day</button>
        <button id="week-view-btn" type="button" role="tab" aria-controls="week-view">Week</button>
        <button id="month-view-btn" type="button" role="tab" aria-controls="month-view">Month</button>
      </div>

      <button id="open-booking-modal" class="btn" type="button">Add booking</button>
    </div>
  </div>

  <section id="day-view" class="calendar-view active" data-start-hour="{{ day_start_hour }}">
    <div class="admin-grid">
      <div class="day-calendar" aria-label="Day timeline">
        <div id="now-indicator" aria-hidden="true">
          <span class="now-dot"></span>
          <span class="now-line"></span>
        </div>

        {% for h in day_hours %}
        <div class="time-slot" data-time="{{ " %02d:00"|format(h) }}">{{ "%02d:00"|format(h) }}</div>
        {% endfor %}

        <!-- Booking blocks container -->
        <div class="booking-blocks-container" id="booking-blocks">
          {% for b in bookings %}
          <div class="booking-block" data-id="{{ b.id }}" data-start="{{ b.start_time }}" data-end="{{ b.end_time }}"
            data-customer="{{ b.customer_name }}" data-service-id="{{ b.service_id or '' }}"
            data-service="{{ b.service_name or 'Service' }}" data-barber-id="{{ b.barber_id or '' }}"
            data-barber="{{ b.barber_name or 'Any barber' }}" data-phone="{{ b.customer_phone or '' }}"
            data-email="{{ b.customer_email or '' }}" data-notes="{{ b.notes or '' }}" data-status="{{ b.status }}"
            style="display:none;">
            <div class="booking-block-time">{{ b.start_time[11:16] }}</div>
            <div class="booking-block-name">{{ b.customer_name }}</div>
            <div class="booking-block-meta">{{ b.service_name or 'Service' }} · {{ b.barber_name or 'Any' }}</div>
          </div>
          {% endfor %}
        </div>
      </div>

      <aside class="side-panel">
        <h2 class="panel-title">Bookings for {{ date }}</h2>

        {% if bookings|length == 0 %}
        <p class="muted">No bookings for this day.</p>
        {% else %}
        <div class="booking-list">
          {% for b in bookings %}
          <div class="booking-card" data-booking-id="{{ b.id }}">
            <div class="booking-time">
              {{ b.start_time[11:16] }}{% if b.end_time %}–{{ b.end_time[11:16] }}{% endif %}
            </div>
            <div class="booking-main">
              <div class="booking-name">{{ b.customer_name }}</div>
              <div class="booking-meta">
                {% if b.service_name %}{{ b.service_name }}{% elif b.service_id %}Service #{{ b.service_id }}{% else
                %}Service (unspecified){% endif %}
                ·
                {% if b.barber_name %}{{ b.barber_name }}{% elif b.barber_id %}Barber #{{ b.barber_id }}{% else %}Any
                barber{% endif %}
                {% if b.status == 'cancelled' %} · <span class="pill bad">cancelled</span>{% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </aside>
    </div>
  </section>

  <section id="week-view" class="calendar-view">
    <h2 class="panel-title">Week view</h2>
    <div class="week-grid">
      {% for d in week_days %}
      <div class="week-day">
        <div class="week-head">
          <div class="week-label">{{ d.label }}</div>
          <div class="week-date">{{ d.date }}</div>
        </div>

        {% if d.bookings|length == 0 %}
        <div class="muted" style="margin-top:8px;">No bookings</div>
        {% else %}
        <div class="week-bookings">
          {% for b in d.bookings %}
          <div class="booking-mini">
            <span class="booking-mini-time">{{ b.start_time[11:16] }}</span>
            <span class="booking-mini-name">{{ b.customer_name }}</span>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </section>

  <section id="month-view" class="calendar-view">
    <div class="month-head">
      <h2 class="panel-title">{{ month_label }}</h2>
    </div>

    <div class="month-grid month-grid-with-dow">
      {% for dow in ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"] %}
      <div class="dow">{{ dow }}</div>
      {% endfor %}

      {% for cell in month_cells %}
      {% if cell %}
      <div class="date-cell{% if cell.is_selected %} selected{% endif %}{% if cell.is_today %} today{% endif %}"
        data-date="{{ cell.date }}">
        <div class="date-num">{{ cell.day }}</div>

        {% if cell.count > 0 %}
        <div class="date-dots" aria-label="{{ cell.count }} bookings">
          {% for _ in range(cell.count if cell.count < 4 else 3) %} <span class="dot"></span>
            {% endfor %}
            {% if cell.count > 3 %}
            <span class="dot-more">+{{ cell.count - 3 }}</span>
            {% endif %}
        </div>
        {% endif %}
      </div>
      {% else %}
      <div class="date-cell empty"></div>
      {% endif %}
      {% endfor %}
    </div>
  </section>
</div>

<div id="booking-modal" class="modal" aria-hidden="true">
  <div class="modal-backdrop" data-modal-close></div>

  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="booking-modal-title">
    <div class="modal-head">
      <h2 id="booking-modal-title">Create booking</h2>
      <button class="icon-btn" type="button" aria-label="Close" data-modal-close>×</button>
    </div>

    <form method="post" action="{{ url_for('admin.create_booking') }}" class="modal-form" id="booking-form">
      <input type="hidden" name="booking_id" id="booking-id" value="">

      <div class="grid-2">
        <div class="field">
          <label for="booking-customer-name">Customer name</label>
          <input id="booking-customer-name" name="customer_name" required />
        </div>

        <div class="field">
          <label for="booking-phone">Customer phone (optional)</label>
          <input id="booking-phone" name="customer_phone" />
        </div>

        <div class="field">
          <label for="booking-email">Customer email (optional)</label>
          <input id="booking-email" name="customer_email" type="email" />
        </div>

        <div class="field">
          <label for="booking-service">Service</label>
          <select id="booking-service" name="service_id" required>
            <option value="" disabled selected>Select a service</option>
            {% for s in services %}
            <option value="{{ s.id }}">{{ s.name }} ({{ s.duration_min }}m) · ${{ "%.2f"|format(s.price) }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="field">
          <label for="booking-barber">Barber (optional)</label>
          <select id="booking-barber" name="barber_id">
            <option value="">Any barber</option>
            {% for b in barbers %}
            <option value="{{ b.id }}">{{ b.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="field">
          <label for="booking-date">Date</label>
          <input id="booking-date" name="date" type="date" value="{{ date }}" required />
        </div>

        <div class="field">
          <label for="booking-time">Time</label>
          <input id="booking-time" name="time" type="time" required />
        </div>

        <div class="field" style="grid-column: 1 / -1;">
          <label for="booking-notes">Notes (optional)</label>
          <textarea id="booking-notes" name="notes" rows="2"></textarea>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn" type="submit" id="modal-submit-btn">Create</button>
        <button class="btn btn-outline" type="button" id="modal-delete-btn" style="display:none;">Delete</button>
        <button class="btn btn-outline" type="button" data-modal-close>Cancel</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/admin_calendar.js') }}" defer></script>
{% endblock %}